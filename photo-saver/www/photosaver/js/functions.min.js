/*
 * functions v  (build 20160708_152457_1)
 * Copyright (c) 2016
 * Author: Chad Keibler 
 */

function Authentication(a){return{validateUser:function(b,c){for(var d=a.users,e=0;e<=d.length-1;e++)if(b.toLowerCase()===d[e].username.toLowerCase()&&c===d[e].password)return!0;return!1},isAuthorized:function(a){return!!a}}}function ConfigPageObjCreator(){return{init:function(a,b,c){configs=a,sort=b,paginate=c},getSortedPageObj:function(a,b,c,d){var e,f=null,g=configs.configurations;e=a?a:1,d&&(f="desc"===d.toLowerCase()?sort.getSortDesc(c):sort.getSortAsc(c)),f&&b&&(g=paginate.paginateUserConfigs(f,b,e));var h={};return h.sorted=g,h.total=configs.configurations.length,h}}}function HttpHandler(a,b,c,d,e,f){var g=a.join(b,"/configurations.json");return{handleGetRequest:function(a,b,c){e.get(a,b,c)},handlePostRequest:function(a,b,c){e.post(g,a,b,c)},handlePutRequest:function(a,b,c){e.put(g,a,b,c)},handleDeleteRequest:function(a,b,c){e["delete"](g,a,b,c)}}}function Paginator(a){return{paginateUserConfigs:function(b,c,d){var e=null;if(a.configurations.length>c)if(parseInt(d)>1){var f=parseInt(c)*(parseInt(d)-1),g=a.configurations.length;parseInt(f)>parseInt(g)?e=b.slice(f,f+c):(parseInt(g)-parseInt(f)>parseInt(c)&&(g=parseInt(f)+parseInt(c)),e=b.slice(f,g))}else e=b.slice(0,c);else e=b;return e}}}function ResponseService(){return{write200Success:function(a,b,c,d){return b?(a.writeHeader(200,{"Content-Type":d}),a.write(b,"binary"),void a.end()):(a.writeHeader(200),a.write("200 OK"),void a.end())},write200OKWithData:function(a,b){a.writeHeader(200,{"Content-Type":"application/json"}),a.write(JSON.stringify(b)),a.end()},write204NoContent:function(a){a.writeHeader(204),a.write("204 No Content"),a.end()},write400BadRequest:function(a){a.writeHeader(400),a.write("400 Bad Request"),a.end()},write401Unauthorized:function(a){a.writeHeader(401),a.write("401 Unauthorized"),a.end()},write404NotFound:function(a){a.writeHeader(404),a.write("404 Not Found"),a.end()},write405MethodNotAllowed:function(a){a.writeHeader(405,{Allow:"GET"}),a.write("405 Method Not Allowed"),a.end()},write500InternalError:function(a,b){a.writeHeader(500),a.write("500 Internal Server Error: "+b+"\n"),a.end()}}}function Router(a,b,c,d,e,f,g,h,i){return{renderFile:function(a,c,d){b.readFile(c,"binary",function(b,e){return b?(console.log("error for file : "+c+" err: "+b),void g.write500InternalError(a,b)):void g.write200Success(a,e,c,d)})},get:function(b,h,j){var k=c.parse(h.url).pathname,l=a.join(d,k);switch(k.trim().toLowerCase()){case"/":return void this.renderFile(b,indexHtml,j);case"/validateuser":var m=h.headers.authorization;if(m){var n=m.split(" ")[1],o=i(n,"base64").toString(),p=o.split(":");if(p){var q=p[0],r=p[1];return f.validateUser(q,r)?(token=i("username:"+q+",password:"+r).toString("base64"),void g.write200Success(b,null,l,j,token)):void g.write401Unauthorized(b)}}return void g.write401Unauthorized(b);case"/user-configurations":return f.isAuthorized(token)?void this.renderFile(b,indexHtml,j):void g.write401Unauthorized(b);case"/configs":var s=c.parse(h.url,!0).query.page,t=c.parse(h.url,!0).query.pagesize,u=c.parse(h.url,!0).query.sortby,v=c.parse(h.url,!0).query.sortorder,w={};return w=e.getSortedPageObj(s,t,u,v),void g.write200OKWithData(b,w);default:return void this.renderFile(b,l,j)}},post:function(a,d,e,i){var j=c.parse(e.url).pathname;switch(j){case"/logout":token=null,g.write204NoContent(d);break;case"/configs":var k=!1,l="";return f.isAuthorized(token)?(e.on("data",function(a){a&&(l+=a)}),void e.on("end",function(){if(l.length>0){var c=JSON.parse(l).config;return c&&(h.configurations?(h.configurations.push(c),k=!0):(h.configurations={config:c},k=!0)),k?(b.writeFileSync(a,JSON.stringify(h)),void g.write204NoContent(d)):void g.write500InternalError(d,"Internal Server Error")}g.write400BadRequest(d)})):void g.write401Unauthorized(d);default:g.write404NotFound(d)}},put:function(a,d,e,i){var j=c.parse(e.url).pathname;if(!f.isAuthorized(token))return void g.write401Unauthorized(d);switch(j){case"/configs":var k="";e.on("data",function(a){a&&(k+=a)}),e.on("end",function(){if(k.length>0){for(var c,e=JSON.parse(k).config,f=0;f<h.configurations.length;f++)h.configurations[f].username===e.username&&(c=h.configurations.indexOf(h.configurations[f]));if(c>-1)return h.configurations[c]=e,b.writeFileSync(a,JSON.stringify(h)),void g.write204NoContent(d)}else g.write400BadRequest(d)});break;default:g.write404NotFound(d)}},"delete":function(a,d,e,i){var j=c.parse(e.url,!0).query.id,k=c.parse(e.url).pathname;if(!f.isAuthorized(token))return void g.write401Unauthorized(d);switch(k){case"/configs":for(var l=null,m=0;m<h.configurations.length;m++)h.configurations[m].username===j&&(l=h.configurations.indexOf(h.configurations[m]));if(l>-1)return h.configurations.splice(l,1),b.writeFileSync(a,JSON.stringify(h)),d.writeHeader(204),void d.end();break;default:g.write404NotFound(d)}}}}function Sorter(a){return{sortByHostNameAsc:function(){return a.configurations.sort(function(a,b){return a.hostname.toLowerCase()<b.hostname.toLowerCase()?-1:a.hostname.toLowerCase()>b.hostname.toLowerCase()?1:0})},sortByUserNameAsc:function(){return a.configurations.sort(function(a,b){return a.username.toLowerCase()<b.username.toLowerCase()?-1:a.username.toLowerCase()>b.username.toLowerCase()?1:0})},sortByPortAsc:function(){return a.configurations.sort(function(a,b){return a.port<b.port?-1:a.port>b.port?1:0})},sortByNameAsc:function(){return a.configurations.sort(function(a,b){return a.name.toLowerCase()<b.name.toLowerCase()?-1:a.name.toLowerCase()>b.name.toLowerCase()?1:0})},getSortAsc:function(a){if(a){if("hostname"===a.toLowerCase())return this.sortByHostNameAsc();if("port"===a.toLowerCase())return this.sortByPortAsc();if("username"===a.toLowerCase())return this.sortByUserNameAsc()}return this.sortByNameAsc()},sortByNameDesc:function(){return a.configurations.sort(function(a,b){return a.name.toLowerCase()>b.name.toLowerCase()?-1:a.name.toLowerCase()<b.name.toLowerCase()?1:0})},sortByHostNameDesc:function(){return a.configurations.sort(function(a,b){return a.hostname.toLowerCase()>b.hostname.toLowerCase()?-1:a.hostname.toLowerCase()<b.hostname.toLowerCase()?1:0})},sortByPortDesc:function(){return a.configurations.sort(function(a,b){return a.port>b.port?-1:a.port<b.port?1:0})},sortByUserNameDesc:function(){return a.configurations.sort(function(a,b){return a.username.toLowerCase()>b.username.toLowerCase()?-1:a.username.toLowerCase()<b.username.toLowerCase()?1:0})},getSortDesc:function(a){if(a){if("hostname"===a.toLowerCase())return this.sortByHostNameDesc();if("port"===a.toLowerCase())return this.sortByPortDesc();if("username"===a.toLowerCase())return this.sortByUserNameDesc()}return this.sortByNameDesc()}}}module.exports=Authentication;var configs,sort,paginate;module.exports=ConfigPageObjCreator,module.exports=HttpHandler,module.exports=Paginator,module.exports=ResponseService;var token=null,path,fileSystem,url,currentWorkingDir,configPageObjCreator,authentication,responseService,configs,Buffer,indexHtml="./index.html";module.exports=Router,module.exports=Sorter;