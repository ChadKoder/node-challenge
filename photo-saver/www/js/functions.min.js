/*
 * functions v  (build 20160707_113901_1)
 * Copyright (c) 2016
 * Author: Chad Keibler 
 */

function Authentication(a){return{validateUser:function(b,c){for(var d=a.users,e=0;e<=d.length-1;e++)if(b.toLowerCase()===d[e].username.toLowerCase()&&c===d[e].password)return!0;return!1},isAuthorized:function(a){return!!a}}}function ConfigPageObjCreator(){return{init:function(a,b,c){configs=a,sort=b,paginate=c},getSortedPageObj:function(a,b,c,d){var e,f=null,g=configs.configurations;e=a?a:1,d&&(f="desc"===d.toLowerCase()?sort.getSortDesc(c):sort.getSortAsc(c)),f&&b&&(g=paginate.paginateUserConfigs(f,b,e));var h={};return h.sorted=g,h.total=configs.configurations.length,h}}}function HttpHandler(a,b,c,d,e,f){var g=a.join(b,"/configurations.json");return{handleGetRequest:function(a,c,d){e.get(b,a,c,d)},handlePostRequest:function(a,b,c){e.post(g,a,b,c)},handlePutRequest:function(a,b,c){e.put(g,a,b,c)},handleDeleteRequest:function(a,b,c){e["delete"](g,a,b,c)}}}function Paginator(a){return{paginateUserConfigs:function(b,c,d){var e=null;if(a.configurations.length>c)if(parseInt(d)>1){var f=parseInt(c)*(parseInt(d)-1),g=a.configurations.length;parseInt(f)>parseInt(g)?e=b.slice(f,f+c):(parseInt(g)-parseInt(f)>parseInt(c)&&(g=parseInt(f)+parseInt(c)),e=b.slice(f,g))}else e=b.slice(0,c);else e=b;return e}}}function ResponseService(){return{write200Success:function(a,b,c,d){return b?(a.writeHeader(200,{"Content-Type":d}),a.write(b,"binary"),void a.end()):(a.writeHeader(200),a.write("200 OK"),void a.end())},write200OKWithData:function(a,b){a.writeHeader(200,{"Content-Type":"application/json"}),a.write(JSON.stringify(b)),a.end()},write204NoContent:function(a){a.writeHeader(204),a.write("204 No Content"),a.end()},write400BadRequest:function(a){a.writeHeader(400),a.write("400 Bad Request"),a.end()},write401Unauthorized:function(a){a.writeHeader(401),a.write("401 Unauthorized"),a.end()},write404NotFound:function(a){a.writeHeader(404),a.write("404 Not Found"),a.end()},write405MethodNotAllowed:function(a){a.writeHeader(405,{Allow:"GET"}),a.write("405 Method Not Allowed"),a.end()},write500InternalError:function(a,b){a.writeHeader(500),a.write("500 Internal Server Error: "+b+"\n"),a.end()}}}function Router(){return{init:function(a,b,c,d,e,f,g,h,i){path=a,fileSystem=b,currentWorkingDir=d,authentication=f,responseService=g,configPageObjCreator=e,configs=h,Buffer=i,url=c},renderFile:function(a,b,c){fileSystem.readFile(b,"binary",function(d,e){return d?(console.log("error for file : "+b+" err: "+d),void responseService.write500InternalError(a,d)):void responseService.write200Success(a,e,b,c)})},get:function(a,b,c,d){var e=url.parse(c.url).pathname;switch(e.trim().toLowerCase()){case"/":return void this.renderFile(b,indexHtml,d);case"/validateuser":var f=c.headers.authorization;if(f){var g=f.split(" ")[1],h=Buffer(g,"base64").toString(),i=h.split(":");if(i){var j=i[0],k=i[1];return authentication.validateUser(j,k)?(token=Buffer("username:"+j+",password:"+k).toString("base64"),void responseService.write200Success(b,null,a,d,token)):void responseService.write401Unauthorized(b)}}return void responseService.write401Unauthorized(b);case"/user-configurations":return authentication.isAuthorized(token)?void this.renderFile(b,indexHtml,d):void responseService.write401Unauthorized(b);case"/configs":var l=url.parse(c.url,!0).query.page,m=url.parse(c.url,!0).query.pagesize,n=url.parse(c.url,!0).query.sortby,o=url.parse(c.url,!0).query.sortorder,p={};return p=configPageObjCreator.getSortedPageObj(l,m,n,o),void responseService.write200OKWithData(b,p);default:return void this.renderFile(b,a,d)}},post:function(a,b,c,d){var e=url.parse(c.url).pathname;switch(e){case"/logout":token=null,responseService.write204NoContent(b);break;case"/configs":var f=!1,g="";return authentication.isAuthorized(token)?(c.on("data",function(a){a&&(g+=a)}),void c.on("end",function(){if(g.length>0){var c=JSON.parse(g).config;return c&&(configs.configurations?(configs.configurations.push(c),f=!0):(configs.configurations={config:c},f=!0)),f?(fileSystem.writeFileSync(a,JSON.stringify(configs)),void responseService.write204NoContent(b)):void responseService.write500InternalError(b,"Internal Server Error")}responseService.write400BadRequest(b)})):void responseService.write401Unauthorized(b);default:responseService.write404NotFound(b)}},put:function(a,b,c,d){var e=url.parse(c.url).pathname;if(!authentication.isAuthorized(token))return void responseService.write401Unauthorized(b);switch(e){case"/configs":var f="";c.on("data",function(a){a&&(f+=a)}),c.on("end",function(){if(f.length>0){for(var c,d=JSON.parse(f).config,e=0;e<configs.configurations.length;e++)configs.configurations[e].username===d.username&&(c=configs.configurations.indexOf(configs.configurations[e]));if(c>-1)return configs.configurations[c]=d,fileSystem.writeFileSync(a,JSON.stringify(configs)),void responseService.write204NoContent(b)}else responseService.write400BadRequest(b)});break;default:responseService.write404NotFound(b)}},"delete":function(a,b,c,d){var e=url.parse(c.url,!0).query.id,f=url.parse(c.url).pathname;if(!authentication.isAuthorized(token))return void responseService.write401Unauthorized(b);switch(f){case"/configs":for(var g=null,h=0;h<configs.configurations.length;h++)configs.configurations[h].username===e&&(g=configs.configurations.indexOf(configs.configurations[h]));if(g>-1)return configs.configurations.splice(g,1),fileSystem.writeFileSync(a,JSON.stringify(configs)),b.writeHeader(204),void b.end();break;default:responseService.write404NotFound(b)}}}}function Sorter(a){return{sortByHostNameAsc:function(){return a.configurations.sort(function(a,b){return a.hostname.toLowerCase()<b.hostname.toLowerCase()?-1:a.hostname.toLowerCase()>b.hostname.toLowerCase()?1:0})},sortByUserNameAsc:function(){return a.configurations.sort(function(a,b){return a.username.toLowerCase()<b.username.toLowerCase()?-1:a.username.toLowerCase()>b.username.toLowerCase()?1:0})},sortByPortAsc:function(){return a.configurations.sort(function(a,b){return a.port<b.port?-1:a.port>b.port?1:0})},sortByNameAsc:function(){return a.configurations.sort(function(a,b){return a.name.toLowerCase()<b.name.toLowerCase()?-1:a.name.toLowerCase()>b.name.toLowerCase()?1:0})},getSortAsc:function(a){if(a){if("hostname"===a.toLowerCase())return this.sortByHostNameAsc();if("port"===a.toLowerCase())return this.sortByPortAsc();if("username"===a.toLowerCase())return this.sortByUserNameAsc()}return this.sortByNameAsc()},sortByNameDesc:function(){return a.configurations.sort(function(a,b){return a.name.toLowerCase()>b.name.toLowerCase()?-1:a.name.toLowerCase()<b.name.toLowerCase()?1:0})},sortByHostNameDesc:function(){return a.configurations.sort(function(a,b){return a.hostname.toLowerCase()>b.hostname.toLowerCase()?-1:a.hostname.toLowerCase()<b.hostname.toLowerCase()?1:0})},sortByPortDesc:function(){return a.configurations.sort(function(a,b){return a.port>b.port?-1:a.port<b.port?1:0})},sortByUserNameDesc:function(){return a.configurations.sort(function(a,b){return a.username.toLowerCase()>b.username.toLowerCase()?-1:a.username.toLowerCase()<b.username.toLowerCase()?1:0})},getSortDesc:function(a){if(a){if("hostname"===a.toLowerCase())return this.sortByHostNameDesc();if("port"===a.toLowerCase())return this.sortByPortDesc();if("username"===a.toLowerCase())return this.sortByUserNameDesc()}return this.sortByNameDesc()}}}module.exports=Authentication;var configs,sort,paginate;module.exports=ConfigPageObjCreator,module.exports=HttpHandler,module.exports=Paginator,module.exports=ResponseService;var token=null,path,fileSystem,url,currentWorkingDir,configPageObjCreator,authentication,responseService,configs,Buffer,indexHtml="./index.html";module.exports=Router,module.exports=Sorter;